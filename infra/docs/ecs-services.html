<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ECS services management - Rust Forge</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Supplemental documentation for contributing to The Rust Programming Language">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Forge</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-forge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-forge/edit/master/src/infra/docs/ecs-services.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ecs-services-management"><a class="header" href="#ecs-services-management">ECS services management</a></h1>
<p>Some applications running on the project’s infrastructure are hosted in ECS
clusters on our AWS account. This document explains the common maintenance
procedures one should follow when operating them. Most of the actions explained
here <a href="aws-access.html">require AWS access</a>.</p>
<blockquote>
<p><strong>Note:</strong> our ECS cluster is located in the Northern California
(<code>us-west-1</code>) AWS region. Make sure it’s the selected region when interacting
with the AWS console.</p>
</blockquote>
<h2 id="inspecting-the-logs"><a class="header" href="#inspecting-the-logs">Inspecting the logs</a></h2>
<p>Logs for applications hosted on ECS are stored in CloudWatch Logs, and can
be inspected in the AWS Console. <a href="aws-access.html#using-the-aws-console">Open the console</a>, go to
CloudWatch Logs and select the log group called <code>/ecs/&lt;service-name&gt;</code>. There
are two ways to inspect the logs:</p>
<ul>
<li>
<p>If you need to look at the application as a whole, you can get an aggregated
view by clicking the “View all log events” button (or, on the classic
interface, “Search Log Group”).</p>
</li>
<li>
<p>If you need to debug a specific instance of a container, separate log streams
for each running task are available. The streams are named after the
container name and the task ID.</p>
</li>
</ul>
<p>Logs are periodically purged (retention varies based on the specific
application).</p>
<h2 id="restarting-an-application"><a class="header" href="#restarting-an-application">Restarting an application</a></h2>
<p>To restart an application, you can force a new deployment without actually
pushing any new code beforehand. To do so, run this command:</p>
<pre><code>aws ecs update-service --cluster rust-ecs-prod --service &lt;service-name&gt; --force-new-deployment
</code></pre>
<h2 id="rolling-back-a-deployment"><a class="header" href="#rolling-back-a-deployment">Rolling back a deployment</a></h2>
<p>To rollback a bad deployment you can run the <a href="https://github.com/rust-lang/simpleinfra/blob/master/aws-rollback.py"><code>aws-rollback.py</code></a> script (stored
in the simpleinfra repository) with your <a href="aws-access.html">AWS credentials</a> present
in the shell. The script requires the name of the ECR container image
repository as its first and only argument:</p>
<pre><code>./aws-rollback.py &lt;image-repository-name&gt;
</code></pre>
<p>The script will show the list of images available in the repository, and asks
for the image number to rollback to. Once that’s inserted the script will point
the <code>latest</code> tag to the image you chose, and if an ECS service with the same
name as the repository exists that service will be restarted too.</p>
<h2 id="deploying-application-changes"><a class="header" href="#deploying-application-changes">Deploying application changes</a></h2>
<p>Each application stores its own Docker container in a <a href="https://aws.amazon.com/ecr/">ECR repository</a> in
our AWS account. You can deploy changes both manually and automatically (with
GitHub Actions).</p>
<p>For production applications it’s recommended to setup automatic deployment.</p>
<h3 id="manual-deployments"><a class="header" href="#manual-deployments">Manual deployments</a></h3>
<p>To manually deploy a local build you first need it to tag your built image
with its ECR name:</p>
<pre><code>docker tag &lt;image-tag&gt; 890664054962.dkr.ecr.us-west-1.amazonaws.com/&lt;repository-name&gt;:latest
</code></pre>
<p>Then you can authenticate with ECR and push it:</p>
<pre><code>$(aws ecr get-login --no-include-email --region us-west-1)
docker push 890664054962.dkr.ecr.us-west-1.amazonaws.com/&lt;repository-name&gt;:latest
</code></pre>
<p>Finally, you need to force a new deployment of the ECS service with:</p>
<pre><code>aws ecs update-service --cluster rust-ecs-prod --service &lt;service-name&gt; --force-new-deployment
</code></pre>
<h3 id="automatic-deployments-with-github-actions"><a class="header" href="#automatic-deployments-with-github-actions">Automatic deployments with GitHub Actions</a></h3>
<p>The infrastructure team prepared an action for GitHub Actions that automates
deployments from CI. To use it, ask a team member to setup AWS credentials in
your repository, and then add this snippet to your workflow:</p>
<pre><code>- name: Build the Docker image
  run: docker build -t deploy-image .

- name: Deploy to production
  uses: rust-lang/simpleinfra/github-actions/upload-docker-image@master
  with:
    image: deploy-image
    repository: &lt;ecr-repository-name&gt;
    region: us-west-1
    redeploy_ecs_cluster: rust-ecs-prod
    redeploy_ecs_service: &lt;service-name&gt;
    aws_access_key_id: "${{ secrets.AWS_ACCESS_KEY_ID }}"
    aws_secret_access_key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
  if: github.ref == 'refs/heads/&lt;deploy-branch&gt;'
</code></pre>
<p>Be sure to replace <code>&lt;ecr-repository-name&gt;</code>, <code>&lt;service-name&gt;</code> and
<code>&lt;deploy-branch&gt;</code> with the correct values for your workflow. Once the workflow
changes are merged in the branch you chose for deploys, any future commits
pushed there will be deployed to the ECS cluster.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../infra/docs/docs-rs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../infra/docs/monitoring.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../infra/docs/docs-rs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../infra/docs/monitoring.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../js/moment.min.js"></script>
        <script src="../../js/index.js"></script>


    </div>
    </body>
</html>
