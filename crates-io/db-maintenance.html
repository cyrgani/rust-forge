<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Database maintenance - Rust Forge</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Supplemental documentation for contributing to The Rust Programming Language">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Forge</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-forge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-forge/edit/master/src/crates-io/db-maintenance.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="database-maintenance"><a class="header" href="#database-maintenance">Database maintenance</a></h1>
<p>There are times when Heroku needs to perform a maintenance on our database
instances, for example to apply system updates or upgrade to a newer database
server.</p>
<p>We must <strong>not</strong> let Heroku run maintenances during the maintenance window to
avoid disrupting production users (move the maintenance window if necessary).
This page contains the instructions on how to perform the maintenance with the
minimum amount of disruption.</p>
<h1 id="primary-database"><a class="header" href="#primary-database">Primary database</a></h1>
<p>Performing maintenance on the primary database requires us to temporarily put
the application in read-only mode. Heroku performs maintenances by creating a
hidden database follower and switching over to it, so we need to prevent writes
on the primary to let the follower catch up.</p>
<p>Maintenance should take less than 5 minutes of read-only time, but we should
still announce it ahead of time on our status page. This is a sample message we
can use:</p>
<blockquote>
<p>The crates.io team will perform a database maintenance on YYYY-MM-DD from
hh:mm to hh:mm UTC.</p>
<p>We expect this to take less than 5 minutes to complete. During maintenance,
crates.io will only be available in read-only mode: downloading crates and
visiting the website will still work, but logging in, publishing crates,
yanking crates, or changing owners will not work.</p>
</blockquote>
<h2 id="primary-database-checklist"><a class="header" href="#primary-database-checklist">Primary database checklist</a></h2>
<p><strong>1 hour before the maintenance</strong></p>
<ol>
<li>Go into the Heroku Scheduler and disable the job enqueueing the downloads
count updater. You can “disable” it by changing its schedule not to run
during the maintenance window. The job uses a lot of database resources, and
we should not run it during maintenance.</li>
</ol>
<p><strong>5 minutes before the maintenance</strong></p>
<ol start="2">
<li>
<p>Scale the background worker to 0 instances:</p>
<pre><code>heroku ps:scale -a crates-io background_worker=0
</code></pre>
</li>
</ol>
<p><strong>At the start of the maintenance</strong></p>
<ol start="3">
<li>
<p>Update the status page with this message:</p>
<blockquote>
<p>Scheduled maintenance on our database is starting.</p>
<p>We expect this to take less than 5 minutes to complete. During maintenance,
crates.io will only be available in read-only mode: downloading crates and
visiting the website will still work, but logging in, publishing crates,
yanking crates, or changing owners will not work.</p>
</blockquote>
</li>
<li>
<p>Configure the application to be in read-only mode without the follower:</p>
<pre><code>heroku config:set -a crates-io READ_ONLY_MODE=1 DB_OFFLINE=follower
</code></pre>
<p>The follower is removed because while Heroku tries to prevent connections to
the primary database from failing during maintenance we observed that the
same does not apply to the follower database, and there could be brief
periods while the follower is not available.</p>
</li>
<li>
<p>Wait for the application to be redeployed with the new configuration:</p>
<pre><code>heroku ps:wait -a crates-io
</code></pre>
</li>
<li>
<p>Run the database maintenance:</p>
<pre><code>heroku pg:maintenance:run --force -a crates-io
</code></pre>
</li>
<li>
<p>Wait for the maintenance to finish:</p>
<pre><code>heroku pg:wait -a crates-io
</code></pre>
</li>
<li>
<p>Confirm all the databases are online:</p>
<pre><code>heroku pg:info -a crates-io
</code></pre>
</li>
<li>
<p>Confirm the primary database fully recovered (should output <code>false</code>):</p>
<pre><code>echo "SELECT pg_is_in_recovery();" | heroku pg:psql -a crates-io DATABASE
</code></pre>
</li>
<li>
<p>Switch off read-only mode:</p>
<pre><code>heroku config:unset -a crates-io READ_ONLY_MODE
</code></pre>
<p><strong>WARNING:</strong> the Heroku Dashboard’s UI is misleading when removing an
environment variable. A red badge with a “-” (minus) in it means the
variable was <em>successfully removed</em>, it doesn’t mean removing the variable
failed.  Failures are indicated with a red badge with a “x” (cross) in it.</p>
</li>
<li>
<p>Wait for the application to be redeployed with the new configuration:</p>
<pre><code>heroku ps:wait -a crates-io
</code></pre>
</li>
<li>
<p>Update the status page and mark the maintenance as completed with this
message:</p>
<blockquote>
<p>Scheduled maintenance finished successfully.</p>
</blockquote>
<p>The message is posted right now and not at the end because this is when
production users are not impacted by the maintenance anymore.</p>
</li>
<li>
<p>Scale the background worker up again:</p>
<pre><code>heroku ps:scale -a crates-io background_worker=1
</code></pre>
</li>
<li>
<p>Confirm the follower database is available:</p>
<pre><code>echo "SELECT 1;" | heroku pg:psql -a crates-io READ_ONLY_REPLICA
</code></pre>
</li>
<li>
<p>Enable connections to the follower:</p>
<pre><code>heroku config:unset -a crates-io DB_OFFLINE
</code></pre>
</li>
<li>
<p>Re-enable the background job disabled during step 1.</p>
</li>
</ol>
<h1 id="follower-database"><a class="header" href="#follower-database">Follower database</a></h1>
<p>Performing maintenance on the follower database doesn’t require any external
communication nor putting the application in read-only mode, as we can just
redirect all of the follower’s traffic to the primary database. It shouldn’t be
done during peak traffic periods though, as we’ll increase the primary database
load by doing this.</p>
<h2 id="follower-database-checklist"><a class="header" href="#follower-database-checklist">Follower database checklist</a></h2>
<p><strong>At the start of the maintenance</strong></p>
<ol>
<li>
<p>Configure the application to operate without the follower:</p>
<pre><code>heroku config:set -a crates-io DB_OFFLINE=follower
</code></pre>
</li>
<li>
<p>Wait for the application to be redeployed with the new configuration:</p>
<pre><code>heroku ps:wait -a crates-io
</code></pre>
</li>
<li>
<p>Start the database maintenance:</p>
<pre><code>heroku pg:maintenance:run --force -a crates-io READ_ONLY_REPLICA
</code></pre>
</li>
<li>
<p>Wait for the maintenance to finish:</p>
<pre><code>heroku pg:wait -a crates-io READ_ONLY_REPLICA
</code></pre>
</li>
<li>
<p>Confirm the follower database is ready:</p>
<pre><code>heroku pg:info -a crates-io
</code></pre>
</li>
<li>
<p>Confirm the follower database is responding to queries:</p>
<pre><code>echo "SELECT 1;" | heroku pg:psql -a crates-io READ_ONLY_REPLICA
</code></pre>
</li>
<li>
<p>Enable connections to the follower:</p>
<pre><code>heroku config:unset -a crates-io DB_OFFLINE
</code></pre>
</li>
<li>
<p>Wait for the application to be redeployed with the new configuration.</p>
<pre><code>heroku ps:wait -a crates-io
</code></pre>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../crates-io/crate-removal.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../docs-rs/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../crates-io/crate-removal.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../docs-rs/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../js/moment.min.js"></script>
        <script src="../js/index.js"></script>


    </div>
    </body>
</html>
